// 点击付款按钮时执行（bookId是书籍ID，downloadUrl是对应TXT的下载链接）
function createOrder(bookId, downloadUrl) {
    // 生成唯一订单号（时间戳+书籍ID）
    const orderId = Date.now() + '_' + bookId;
    // 调用站长付创建订单API（已用bec1656b2f83作为标识）
    fetch('https://api.zhanzhangfu.com/createOrder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            appKey: 'bec1656b2f83', // 核心：用这个替代商户ID
            appSecret: '699a1ba62c9746099c25250ff1afa4d0', // 你的AppSecret不变
            orderId: orderId,
            amount: 3.99, // 固定价格
            subject: '书籍购买',
            callbackUrl: 'https://coolchobit.github.io/pay-txt-demo/pay-callback.html', // 你的回调页面
            returnUrl: 'https://coolchobit.github.io/pay-txt-demo/download.html?order='+orderId+'&url='+downloadUrl
        })
    }).then(res => res.json()).then(data => {
        if (data.code === 200) {
            // 弹出支付二维码
            showQrCodeModal(data.qrCodeUrl);
        } else {
            alert('创建订单失败：' + data.msg);
        }
    });
}

// 二维码弹窗函数（已加金额偏差提示）
function showQrCodeModal(qrUrl) {
    const mask = document.createElement('div');
    mask.style = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:999;';
    const qrBox = document.createElement('div');
    qrBox.style = 'background:white;padding:20px;border-radius:8px;text-align:center;';
    qrBox.innerHTML = `
        <h3>扫码支付（3.99元，允许±0.01元偏差）</h3>
        <img src="${qrUrl}" style="width:250px;height:250px;margin:20px 0;" />
        <p>支付金额为3.98/3.99/4.00元均有效</p>
        <button onclick="document.body.removeChild(this.parentElement.parentElement)">关闭</button>
    `;
    mask.appendChild(qrBox);
    document.body.appendChild(mask);
}
